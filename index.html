<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESAT Diagnostic Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
    }
    
    #test-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    #question-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    #question-image {
      flex: 1;
      min-height: 0;
    }
    
    @media (max-width: 768px) {
      #test-container {
        padding: 1rem;
        margin: 0;
        border-radius: 0;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="test-container" class="bg-white p-6 rounded-lg shadow-lg w-full max-w-6xl mx-auto min-h-screen transition-all duration-300">
    <div id="start-screen" class="text-center">
      <h1 class="text-2xl font-bold mb-4">ESAT Diagnostic Test</h1>
      <p class="mb-4">This 30-question test is highly time-pressured (60 seconds per question) to identify gaps in your knowledge. You cannot go back to previous questions. Write answers on paper and submit via email to edwardtownsend2003@gmail.com.</p>
      <p class="mb-4">The number of questions on each topic is proportional to the typical number of questions on that topic in the ESAT.</p>
      <p class="mb-4">You might need to zoom in to read some questions! If you don't get an answer in 60 seconds give it your best guess!</p> 
      <p class="mb-4">Click Start to begin!</p>
      <button id="start-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Start</button>
    </div>
    
    <div id="topic-selection-screen" class="hidden">
      <h2 class="text-2xl font-bold mb-6 text-center">Select Topics to Target</h2>
      <p class="mb-6 text-center text-gray-600">Choose which topics you want to focus on. You can select multiple topics or all of them.</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-mechanics" value="Mechanics" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-mechanics" class="text-sm font-medium text-gray-700">Mechanics</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-algebra" value="Algebra and Functions" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-algebra" class="text-sm font-medium text-gray-700">Algebra and Functions</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-geometry" value="Geometry+Coord Geometry" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-geometry" class="text-sm font-medium text-gray-700">Geometry & Coordinate Geometry</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-calculus" value="Calculus" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-calculus" class="text-sm font-medium text-gray-700">Calculus</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-numbers" value="Numbers" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-numbers" class="text-sm font-medium text-gray-700">Numbers</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-ratio" value="Ratio and Proportion" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-ratio" class="text-sm font-medium text-gray-700">Ratio and Proportion</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-sequences" value="Sequences and Series" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-sequences" class="text-sm font-medium text-gray-700">Sequences and Series</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-trigonometry" value="Trigonometry" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-trigonometry" class="text-sm font-medium text-gray-700">Trigonometry</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-exponentials" value="Exponentials and Logs" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-exponentials" class="text-sm font-medium text-gray-700">Exponentials and Logs</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-electricity" value="Electricity" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-electricity" class="text-sm font-medium text-gray-700">Electricity</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-waves" value="Waves" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-waves" class="text-sm font-medium text-gray-700">Waves</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-radioactivity" value="Radioactivity" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-radioactivity" class="text-sm font-medium text-gray-700">Radioactivity</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-thermal" value="Thermal Physics" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-thermal" class="text-sm font-medium text-gray-700">Thermal Physics</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-gases" value="Ideal Gases and Density" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-gases" class="text-sm font-medium text-gray-700">Ideal Gases and Density</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-stats" value="Stats+Prob" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-stats" class="text-sm font-medium text-gray-700">Statistics & Probability</label>
        </div>
        
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="topic-magnetism" value="Magnetism" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
          <label for="topic-magnetism" class="text-sm font-medium text-gray-700">Magnetism</label>
        </div>
      </div>
      
      <div class="flex justify-center space-x-4 mb-6">
        <button id="select-all-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Select All</button>
        <button id="clear-all-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Clear All</button>
      </div>
      
      <div class="text-center">
        <button id="start-test-btn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 text-lg font-semibold" disabled>Start Test</button>
        <p id="selection-info" class="mt-2 text-sm text-gray-600">Please select at least one topic to continue</p>
      </div>
    </div>
    
    <div id="question-screen" class="hidden">
      <div class="flex justify-between mb-4">
        <h2 id="question-number" class="text-lg font-semibold"></h2>
        <div id="timer" class="text-lg font-semibold text-red-500">60</div>
      </div>
      
      <!-- Question text -->
      <div id="question-text" class="text-lg mb-4 p-4 bg-gray-50 rounded-lg"></div>
      
      <!-- Question image (if exists) -->
      <div id="image-container" class="mb-4 hidden">
        <img id="question-image" class="w-full h-auto max-h-[50vh] object-contain" src="" alt="Question">
      </div>
      
      <!-- Multiple choice options -->
      <div id="options-container" class="mb-4">
        <div id="options-list" class="space-y-3"></div>
      </div>
      
      <!-- Warning message that appears at 10 seconds -->
      <div id="warning-message" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <strong>10 seconds left! Make your best guess now!</strong>
        </div>
      </div>
    </div>
    <div id="end-screen" class="hidden text-center">
      <h2 class="text-2xl font-bold mb-4">Test Complete</h2>
      <p class="mb-4">Submit your answer sheet via email to edwardtownsend2003@gmail.com</p>
    </div>
  </div>

  <script>
    let questions = [];
    let filteredQuestions = [];
    let currentQuestion = 0;
    let timer;
    const timeLimit = 80; // 80 seconds per question
    let warningShown = false;
    let selectedAnswer = null;
    let selectedTopics = [];

    const startScreen = document.getElementById('start-screen');
    const topicSelectionScreen = document.getElementById('topic-selection-screen');
    const questionScreen = document.getElementById('question-screen');
    const endScreen = document.getElementById('end-screen');
    const startBtn = document.getElementById('start-btn');
    const startTestBtn = document.getElementById('start-test-btn');
    const selectAllBtn = document.getElementById('select-all-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const selectionInfo = document.getElementById('selection-info');
    const questionNumber = document.getElementById('question-number');
    const questionText = document.getElementById('question-text');
    const imageContainer = document.getElementById('image-container');
    const questionImage = document.getElementById('question-image');
    const optionsList = document.getElementById('options-list');
    const timerDiv = document.getElementById('timer');
    const warningMessage = document.getElementById('warning-message');
    const testContainer = document.getElementById('test-container');

    startBtn.addEventListener('click', showTopicSelection);
    startTestBtn.addEventListener('click', startTest);
    selectAllBtn.addEventListener('click', selectAllTopics);
    clearAllBtn.addEventListener('click', clearAllTopics);

    // Add event listeners to all topic checkboxes
    document.addEventListener('DOMContentLoaded', function() {
      const topicCheckboxes = document.querySelectorAll('input[type="checkbox"]');
      topicCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionInfo);
      });
    });

    function showTopicSelection() {
      startScreen.classList.add('hidden');
      topicSelectionScreen.classList.remove('hidden');
    }

    function selectAllTopics() {
      const topicCheckboxes = document.querySelectorAll('input[type="checkbox"]');
      topicCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
      updateSelectionInfo();
    }

    function clearAllTopics() {
      const topicCheckboxes = document.querySelectorAll('input[type="checkbox"]');
      topicCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      updateSelectionInfo();
    }

    function updateSelectionInfo() {
      const topicCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      selectedTopics = Array.from(topicCheckboxes).map(cb => cb.value);
      
      if (selectedTopics.length > 0) {
        startTestBtn.disabled = false;
        startTestBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        startTestBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
        selectionInfo.textContent = `Selected ${selectedTopics.length} topic(s): ${selectedTopics.join(', ')}`;
        selectionInfo.className = 'mt-2 text-sm text-green-600';
      } else {
        startTestBtn.disabled = true;
        startTestBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        startTestBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        selectionInfo.textContent = 'Please select at least one topic to continue';
        selectionInfo.className = 'mt-2 text-sm text-gray-600';
      }
    }

    // Load questions from JSON file
    async function loadQuestions() {
      try {
        console.log('Attempting to load questions from: questions/questions.json');
        const response = await fetch('questions/questions.json');
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        console.log('Raw response text (first 200 chars):', text.substring(0, 200));
        
        questions = JSON.parse(text);
        if (!questions || questions.length === 0) {
          throw new Error('No questions found in JSON file');
        }
        console.log('Successfully loaded questions:', questions.length);
        console.log('First question:', questions[0]);
        
        // Filter questions based on selected topics
        filterQuestionsByTopics();
        
      } catch (error) {
        console.error('Error loading questions:', error);
        console.error('Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        alert(`Failed to load questions: ${error.message}\n\nPlease ensure:\n1. You're running this from a web server (not opening the HTML file directly)\n2. questions.json exists in the questions folder\n3. The JSON file is valid`);
        throw error; // Re-throw to prevent the test from starting
      }
    }

    function filterQuestionsByTopics() {
      if (selectedTopics.length === 0) {
        filteredQuestions = questions;
      } else {
        filteredQuestions = questions.filter(q => selectedTopics.includes(q.topic));
      }
      console.log(`Filtered to ${filteredQuestions.length} questions from ${selectedTopics.length} selected topics`);
    }

    // Function to create a beep sound
    function playBeep() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
    
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime); // slightly higher pitch
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(1.0, audioContext.currentTime); // louder
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.0); // longer
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 2.0);
      } catch (e) {
        console.log('Audio not supported:', e);
      }
    }

    async function startTest() {
      try {
        await loadQuestions();
        topicSelectionScreen.classList.add('hidden');
        questionScreen.classList.remove('hidden');
        currentQuestion = 0;
        loadQuestion();
      } catch (error) {
        console.error('Failed to start test:', error);
        // Keep the topic selection screen visible and show error
        topicSelectionScreen.classList.remove('hidden');
      }
    }

    function loadQuestion() {
      console.log('loadQuestion called with currentQuestion:', currentQuestion, 'total questions:', filteredQuestions.length);
      
      if (currentQuestion >= filteredQuestions.length) {
        console.log('Test complete, ending...');
        endTest();
        return;
      }
      
      const q = filteredQuestions[currentQuestion];
      console.log('Loading question data:', q);
      
      questionNumber.textContent = `Question ${currentQuestion + 1} of ${filteredQuestions.length}`;
      
      // Display question text
      questionText.textContent = q.question_text;
      
      // Show/hide image container based on whether image exists
      if (q.question_image) {
        imageContainer.classList.remove('hidden');
        questionImage.src = q.question_image;
      } else {
        imageContainer.classList.add('hidden');
      }
      
      // Display multiple choice options
      displayOptions(q.options);
      
      // Reset selection and warning
      selectedAnswer = null;
      warningShown = false;
      warningMessage.classList.add('hidden');
      testContainer.classList.remove('bg-yellow-50', 'border-2', 'border-yellow-300');
      
      console.log('Starting timer for question:', currentQuestion + 1);
      startTimer();
    }

    function displayOptions(options) {
      optionsList.innerHTML = '';
      const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
      
      options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors';
        optionDiv.dataset.index = index;
        
        optionDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 font-semibold text-gray-600">
            ${letters[index]}
          </div>
          <span class="flex-1">${option}</span>
        `;
        
        optionDiv.addEventListener('click', () => selectOption(index, optionDiv));
        optionsList.appendChild(optionDiv);
      });
    }

    function selectOption(index, optionDiv) {
      console.log('Option selected:', index, 'for question:', currentQuestion);
      
      try {
        // Clear previous selection
        const allOptions = optionsList.querySelectorAll('div');
        allOptions.forEach(opt => {
          opt.classList.remove('border-blue-500', 'bg-blue-50');
          opt.classList.add('border-gray-200');
          const radio = opt.querySelector('.w-8');
          if (radio) {
            radio.classList.remove('bg-blue-500', 'border-blue-500', 'text-white');
            radio.classList.add('border-gray-300', 'text-gray-600');
          }
        });
        
        // Select new option
        optionDiv.classList.remove('border-gray-200');
        optionDiv.classList.add('border-blue-500', 'bg-blue-50');
        const radio = optionDiv.querySelector('.w-8');
        if (radio) {
          radio.classList.remove('border-gray-300', 'text-gray-600');
          radio.classList.add('bg-blue-500', 'border-blue-500', 'text-white');
        }
        
        selectedAnswer = index;
        
        // Disable all options to prevent multiple clicks
        allOptions.forEach(opt => {
          opt.style.pointerEvents = 'none';
          opt.style.opacity = '0.7';
        });
        
        console.log('Timer before clear:', timer);
        clearInterval(timer);
        console.log('Timer after clear:', timer);
        
        // Auto-advance to next question after a short delay
        console.log('Setting timeout to advance to next question in 1 second...');
        
        setTimeout(() => {
          console.log('Timeout fired! Advancing from question', currentQuestion, 'to', currentQuestion + 1);
          currentQuestion++;
          console.log('About to call loadQuestion...');
          loadQuestion();
          console.log('loadQuestion called successfully');
        }, 1000);
        
      } catch (error) {
        console.error('Error in selectOption:', error);
        // Still try to advance to next question even if there's a UI error
        clearInterval(timer);
        setTimeout(() => {
          currentQuestion++;
          loadQuestion();
        }, 1000);
      }
    }

    function startTimer() {
      let timeLeft = timeLimit;
      timerDiv.textContent = timeLeft;
      timer = setInterval(() => {
        timeLeft--;
        timerDiv.textContent = timeLeft;
        
        // Show warning at 10 seconds remaining
        if (timeLeft === 10 && !warningShown) {
          showWarning();
        }
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          currentQuestion++;
          loadQuestion();
        }
      }, 1000);
    }

    function showWarning() {
      warningShown = true;
      
      // Play beep sound
      playBeep();
      
      // Show warning message
      warningMessage.classList.remove('hidden');
      
      // Change background to yellow
      testContainer.classList.add('bg-yellow-50', 'border-2', 'border-yellow-300');
      
      // Flash timer in red
      timerDiv.classList.add('animate-pulse', 'text-red-600');
      
      // Warning stays until question ends - no auto-remove
    }

    function endTest() {
      questionScreen.classList.add('hidden');
      endScreen.classList.remove('hidden');
    }
  </script>
</body>
</html>